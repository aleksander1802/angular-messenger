<div class="conversation">
    <p class="conversation__homepage">
        <a class="conversation__homepage__link" [routerLink]="['/']"
            >Go to Home Page
        </a>
    </p>
    <div class="conversation__header">
        <h2 class="conversation__header__title">Conversation dialog</h2>

        <div class="conversation__header__buttons">
            <div class="conversation__header__buttons__refresh">
                <div *ngIf="countdownSubscription$ | async">
                    Next update in
                    {{ countdownSubscription$ | async }}
                    seconds
                </div>

                <button
                    class="conversation__header__buttons__refresh__button"
                    [disabled]="
                        (isLoading$ | async) || (countdownSubscription$ | async)
                    "
                    (click)="onUpdateConversationMessage()"
                >
                    <mat-icon>refresh</mat-icon>
                </button>
            </div>
        </div>
    </div>

    <div class="conversation__wrapper">
        <div
            class="conversation__list"
            *ngIf="items$ | async as conversationData; else loading"
        >
            <ul class="conversation__list__items" #scrollContainer>
                <li
                    *ngFor="let conversationMessage of conversationData"
                    class="conversation__list__item"
                    [ngClass]="{
                        myMessage:
                            currentLocalStorage.uid ===
                            conversationMessage.authorID.S
                    }"
                >
                    <div class="conversation__list__item">
                        <p class="conversation__list__item__date">
                            {{
                                conversationMessage.createdAt.S
                                    | date : "longDate"
                            }}
                        </p>

                        <div class="conversation__list__item__profile">
                            <div
                                *ngIf="
                                    currentLocalStorage.uid ===
                                        conversationMessage.authorID.S;
                                    else other
                                "
                                class="conversation__list__item__profile__icon"
                            >
                                <img
                                    src="../../../../assets/icons/avatar/avatar_me.png"
                                    alt="my avatar"
                                />
                            </div>

                            <ng-template #other>
                                <div
                                    class="conversation__list__item__profile__icon"
                                >
                                    <img
                                        src="../../../../assets/icons/avatar/avatar_other.png"
                                        alt="my avatar"
                                    />
                                </div>
                            </ng-template>

                            <div
                                class="conversation__list__item__profile__info"
                            >
                                <div
                                    class="conversation__list__item__profile__info__nameDate"
                                >
                                    <span
                                        class="conversation__list__item__profile__info-name"
                                    >
                                        {{
                                            conversationMessage.authorID.S
                                                | peopleName : peopleList
                                        }}</span
                                    >
                                    <span
                                        class="conversation__list__item__profile__info-date"
                                        >{{
                                            conversationMessage.createdAt.S
                                                | date : "shortDate"
                                        }}</span
                                    >
                                </div>
                                <p
                                    class="conversation__list__item__profile__info-message"
                                >
                                    {{ conversationMessage.message.S }}
                                </p>
                            </div>
                        </div>
                    </div>
                </li>
            </ul>
        </div>

        <form
            class="conversation__form"
            *ngIf="conversationForm"
            [formGroup]="conversationForm"
        >
            <div
                class="conversation__form__control"
                [ngClass]="{ invalid: message?.touched && message?.invalid }"
            >
                <input
                    class="conversation__form__control__input"
                    id="message"
                    type="text"
                    formControlName="message"
                    autocomplete="message"
                />
                <div
                    class="validation"
                    *ngIf="message?.touched && message?.invalid"
                >
                    <small *ngIf="getError('message', 'required')">
                        Please enter a message
                    </small>
                </div>
            </div>
            <div class="conversation__form__button-submit">
                <app-cyber-button
                    [disabled]="
                        conversationForm.invalid ||
                        (isLoading$ | async) ||
                        false
                    "
                    type="submit"
                    [buttonText]="'Send'"
                    (click)="onSendConversationMessage()"
                ></app-cyber-button>
            </div>
        </form>
    </div>

    <ng-template #loading>
        <app-loading></app-loading>
    </ng-template>
</div>

<app-cyber-button
    type="button"
    [buttonText]="'Delete'"
    class="delete__button"
    (click)="openDeleteModal()"
>
</app-cyber-button>

<div *ngIf="showDeleteModal">
    <div class="conversation__modal">
        <h2 class="conversation__modal__title">
            Are you sure you want to delete this conversation?
        </h2>
        <div class="conversation__modal__buttons">
            <app-cyber-button
                [disabled]="(isLoading$ | async) || false"
                (click)="confirmDelete()"
                [buttonText]="'Delete'"
            ></app-cyber-button>
            <app-cyber-button
                (click)="cancelDelete()"
                [buttonText]="'Cancel'"
            ></app-cyber-button>
        </div>
    </div>
</div>
